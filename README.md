# K3s Kubeconfig Fetcher & Merger

Этот скрипт предназначен для автоматизации получения файла конфигурации Kubernetes (`k3s.yaml`) с удаленного сервера K3s.

Скрипт выполняет следующие действия:
1. Скачивает конфигурационный файл с удаленного сервера по SSH.
2. Заменяет внутренний адрес сервера на внешний IP.
3. Переименовывает кластер, контекст и пользователя, чтобы избежать конфликтов с `default` именами.
4. Создает резервную копию вашего текущего конфига (`~/.kube/config_prev`).
5. Безопасно объединяет (мерджит) новый конфиг с вашим локальным `~/.kube/config`.
6. Переключает `kubectl` на новый контекст.

## Требования

Для работы скрипта на локальной машине должны быть установлены:

*   **Bash**
*   **scp** (клиент OpenSSH)
*   **kubectl** — для объединения конфигураций и переключения контекста.
*   **yq** — (версия 4.x+) для редактирования YAML файлов.
    *   *MacOS:* `brew install yq`
    *   *Linux:* Следуйте [инструкции на GitHub](https://github.com/mikefarah/yq).

> **Важно:** У вас должен быть настроен беспарольный доступ по SSH (по ключу) к удаленному серверу для указанного пользователя.

## Установка и настройка

1.  **Создайте файл конфигурации:**
    Скопируйте пример конфигурации `.env.example` в файл `.env` рядом со скриптом:

    ```bash
    cp .env.example .env
    ```

2.  **Отредактируйте `.env`:**
    Откройте файл `.env` и укажите свои параметры:

    ```dotenv
    SERVER_IP=192.168.1.100      # Публичный IP вашего K3s сервера
    REMOTE_USER=root             # Пользователь SSH (обычно root или пользователь с правами на чтение /etc/rancher/k3s/k3s.yaml)
    CONTEXT_NAME=my-cluster-prod # Уникальное имя для этого кластера в вашем локальном конфиге
    ```

## Использование

1.  Дайте скрипту права на исполнение:

    ```bash
    chmod +x fetch_and_merge.sh
    ```

2.  Запустите скрипт:

    ```bash
    ./fetch_and_merge.sh
    ```

### Результат работы

После успешного выполнения вы увидите сообщение `>>> Готово.`. Ваш локальный файл `~/.kube/config` будет обновлен, и активный контекст переключится на указанный в `CONTEXT_NAME`.

Проверить подключение можно командой:

  ```bash
    kubectl get nodes
  ```
